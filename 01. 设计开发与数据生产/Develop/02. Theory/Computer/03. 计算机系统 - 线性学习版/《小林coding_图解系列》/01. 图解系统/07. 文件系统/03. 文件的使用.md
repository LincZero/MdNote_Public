# 文件的使用

## 代码demo

我们从用户角度来看文件的话，就是我们要怎么使用文件？首先，我们得通过系统调用来打开一个文件。

![write 的过程](03.%20文件的使用.assets/写到磁盘过程.png)

```c
fd = open(name, flag); // 1. 打开文件。首先用 `open` 系统调用打开文件，`open` 的参数中包含文件的路径名和文件名。
...
write(fd,...);         // 2. 写数据。使用 `write` 写数据，其中 `write` 使用 `open` 所返回的**文件描述符**，并不使用文件名作为参数。
...
close(fd);             // 3. 关闭文件。使用完文件后，要用 `close` 系统调用关闭文件，避免资源的泄露。
```

上面简单的代码是读取一个文件的过程

## 文件描述符

我们打开了一个文件后，操作系统会跟踪进程打开的所有文件，所谓的跟踪呢，就是操作系统为每个进程维护一个打开文件表，文件表里的每一项代表「**文件描述符**」，所以说文件描述符是打开文件的标识。

## 打开文件表

![打开文件表](03.%20文件的使用.assets/文件打开表.png)

操作系统在打开文件表中维护着打开文件的状态和信息：

- **文件指针**：系统跟踪上次读写位置作为当前文件位置指针，这种指针对打开文件的某个进程来说是唯一的；
- **文件打开计数器**：文件关闭时，操作系统必须重用其打开文件表条目，否则表内空间不够用。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件，该计数器跟踪打开和关闭的数量，当该计数为 0 时，系统关闭文件，删除该条目；
- **文件磁盘位置**：绝大多数文件操作都要求系统修改文件数据，该信息保存在内存中，以免每个操作都从磁盘中读取；
- **访问权限**：每个进程打开文件都需要有一个访问模式（创建、只读、读写、添加等），该信息保存在进程的打开文件表中，以便操作系统能允许或拒绝之后的 I/O 请求；

## 用户与系统视角差异 (字节与数据块单位)

- **用户视角**：用户视角里，文件就是一个持久化的数据结构
- **系统视角**：但操作系统并不会关心你想存在磁盘上的任何的数据结构，操作系统的视角是如何把文件数据和磁盘块对应起来。

所以，用户和操作系统对文件的读写操作是有差异的

- **用户**：用户习惯以字节的方式读写文件，**通常以字节为基本单位**
- **系统**：而操作系统则是以数据块来读写文件，**文件系统的基本操作单位是数据块**
- 那屏蔽掉这种差异的工作就是文件系统了

举例：我们来分别看一下，读文件和写文件的过程：

- 当用户进程从文件读取 1 个字节大小的数据时，文件系统则需要获取字节所在的**数据块**，再返回数据块对应的用户进程所需的数据部分。
- 当用户进程把 1 个字节大小的数据写进文件时，文件系统则找到需要写入数据的**数据块**的位置，然后修改数据块中对应的部分，最后再把数据块写回磁盘。











