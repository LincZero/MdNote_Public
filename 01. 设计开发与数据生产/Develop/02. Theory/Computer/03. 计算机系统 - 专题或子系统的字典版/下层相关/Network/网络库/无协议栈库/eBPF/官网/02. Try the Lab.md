# eBPF

# ç›®å½•

# Try the Lab

[å®˜ç½‘åœ¨çº¿è™šæ‹Ÿæœº](https://play.instruqt.com/embed/isovalent/tracks/ebpf-getting-started)

## å…ˆå¯¼

è¿™ä¸ªåœ¨çº¿å®éªŒå°åœ¨å¼€å§‹æ—¶ä¼šæœ‰äº›æç¤ºï¼Œè¿™æ˜¯å› ä¸ºè¿™é‡Œè¦å‡†å¤‡è™šæ‹Ÿç¯å¢ƒéœ€è¦è€—è´¹æ¯”è¾ƒå¤šçš„æ—¶é—´ï¼ˆ1minï¼‰ï¼Œç»™ç‚¹ä¸œè¥¿ç»™ä½ çœ‹é˜²æ­¢ä½ é‚£ä¹ˆé—·ã€‚
ä½†å…¶å®å†…å®¹éƒ½æ˜¯åœ¨å®˜ç½‘ä¸­ â€œWhat is eBPFâ€ æåˆ°è¿‡äº†ï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰ã€‚

æˆ‘ä¼šæŠŠè¿™éƒ¨åˆ†å†…å®¹åœ¨ What is eBPF ç¬”è®°ä¸­é‡å¤ä¸€æ¬¡ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°

ç„¶åæ•´ä¸ªLabå®éªŒä¸€å…±æœ‰4ä¸ªç¯èŠ‚ï¼š

1.  æ„å»ºå¹¶è¿è¡Œ opensnoop
2.  æ£€æŸ¥BPFå¯¹è±¡æ–‡ä»¶
3.  ä½¿ç”¨bpftoolæŸ¥çœ‹åŠ è½½åˆ°å†…æ ¸ä¸­çš„BPFç¨‹åº
4.  æ·»åŠ æ‚¨è‡ªå·±çš„è·Ÿè¸ªæ¶ˆæ¯
5.  eBPFå…¥é—¨æµ‹éªŒ

## æ„å»ºå¹¶è¿è¡Œ opensnoop

### é¡¹ç›®ä»‹ç»

åœ¨å·¦ä¾§ï¼Œæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªé€‰é¡¹å¡ >_ 1ï¸âƒ£ ç»ˆç«¯ 1ã€‚å½“å‰å·¥ä½œç›®å½• ( `/opt/ebpf/bcc/libbpf-tools` ) åŒ…å« BCC é¡¹ç›®ä¸­**è®¸å¤šå¯è§‚å¯Ÿæ€§å·¥å…·çš„æºä»£ç **ã€‚

è¿™ä¸ªå·¥ä½œç›®å½•æ˜¯å¼€æºçš„ï¼Œæ˜¯ [iovisor/bcc](https://github.com/iovisor/bcc) é¡¹ç›®ã€‚

```text
Makefile            cachestat.bpf.c     fsdist.c              mountsnoop.c           slabratetop.h         tcptop.bpf.c
Makefile.btfgen     cachestat.c         fsdist.h              mountsnoop.h           softirqs.bpf.c        tcptop.c
README.md           capable.bpf.c       fsslower.bpf.c        numamove.bpf.c         softirqs.c            tcptop.h
arm64               capable.c           fsslower.c            numamove.c             softirqs.h            tcptracer.bpf.c
bashreadline.bpf.c  capable.h           fsslower.h            offcputime.bpf.c       solisten.bpf.c        tcptracer.c
bashreadline.c      compat.bpf.h        funclatency.bpf.c     offcputime.c           solisten.c            tcptracer.h
bashreadline.h      compat.c            funclatency.c         offcputime.h           solisten.h            trace_helpers.c
bindsnoop.bpf.c     compat.h            funclatency.h         oomkill.bpf.c          stat.h                trace_helpers.h
bindsnoop.c         core_fixes.bpf.h    gethostlatency.bpf.c  oomkill.c              statsnoop.bpf.c       uprobe_helpers.c
bindsnoop.h         cpudist.bpf.c       gethostlatency.c      oomkill.h              statsnoop.c           uprobe_helpers.h
biolatency.bpf.c    cpudist.c           gethostlatency.h      opensnoop.bpf.c        statsnoop.h           vfsstat.bpf.c
biolatency.c        cpudist.h           hardirqs.bpf.c        opensnoop.c            syscall_helpers.c     vfsstat.c
biolatency.h        cpufreq.bpf.c       hardirqs.c            opensnoop.h            syscall_helpers.h     vfsstat.h
biopattern.bpf.c    cpufreq.c           hardirqs.h            powerpc                syscount.bpf.c        wakeuptime.bpf.c
biopattern.c        cpufreq.h           javagc.bpf.c          readahead.bpf.c        syscount.c            wakeuptime.c
biopattern.h        drsnoop.bpf.c       javagc.c              readahead.c            syscount.h            wakeuptime.h
biosnoop.bpf.c      drsnoop.c           javagc.h              readahead.h            tcpconnect.bpf.c      x86
biosnoop.c          drsnoop.h           kernel.config         riscv                  tcpconnect.c   
biosnoop.h          drsnoop_example.txt klockstat.bpf.c       runqlat.bpf.c          tcpconnect.h   
biostacks.bpf.c     errno_helpers.c     klockstat.c           runqlat.c              tcpconnlat.bpf.c
biostacks.c         errno_helpers.h     klockstat.h           runqlat.h              tcpconnlat.c   
biostacks.h         execsnoop.bpf.c     ksnoop.bpf.c          runqlen.bpf.c          tcpconnlat.h   
biotop.bpf.c        execsnoop.c         ksnoop.c              runqlen.c              tcplife.bpf.c  
biotop.c            execsnoop.h         ksnoop.h              runqlen.h              tcplife.c      
biotop.h            exitsnoop.bpf.c     llcstat.bpf.c         runqslower.bpf.c       tcplife.h      
bitesize.bpf.c      exitsnoop.c         llcstat.c             runqslower.c           tcprtt.bpf.c   
bitesize.c          exitsnoop.h         llcstat.h             runqslower.h           tcprtt.c       
bitesize.h          filelife.bpf.c      map_helpers.c         runqslower_example.txt tcprtt.h       
bits.bpf.h          filelife.c          map_helpers.h         sigsnoop.bpf.c         tcpstates.bpf.c
blazesym            filelife.h          maps.bpf.h            sigsnoop.c             tcpstates.c    
blk_types.h         filetop.bpf.c       mdflush.bpf.c         sigsnoop.h             tcpstates.h    
bpftool             filetop.c           mdflush.c             sigsnoop_example.txt   tcpsynbl.bpf.c 
btf_helpers.c       filetop.h           mdflush.h             slabratetop.bpf.c      tcpsynbl.c     
btf_helpers.h       fsdist.bpf.c        mountsnoop.bpf.c      slabratetop.c          tcpsynbl.h     
```

ç”±äºå…¶ç®€å•æ€§ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬ç¤ºä¾‹ä¸­åªä½¿ç”¨å…¶ä¸­çš„ `opensnoop` ã€‚ 
`opensnoop` å¯ä»¥è·Ÿè¸ªç³»ç»ŸèŒƒå›´å†…çš„ `open()` ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶æ‰“å°å„ç§è¯¦ç»†ä¿¡æ¯ã€‚å› æ­¤ï¼Œå®ƒæ˜¯å±•ç¤ºç®€å• eBPF ç”¨ä¾‹çš„ä¼˜ç§€ç¬¬ä¸€ä¸ªç¨‹åºã€‚



### ç¨‹åºç»„æˆ

eBPF åº”ç”¨ç¨‹åºé€šå¸¸ç”±è‡³å°‘ä¸¤éƒ¨åˆ†ç»„æˆï¼š

-   ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç¨‹åºï¼ˆUSPï¼‰ï¼Œå®ƒå£°æ˜å†…æ ¸ç©ºé—´ç¨‹åºå¹¶å°†å…¶é™„åŠ åˆ°ç›¸å…³çš„è·Ÿè¸ªç‚¹/æ¢é’ˆã€‚
-   ä¸€æ—¦æ»¡è¶³è·Ÿè¸ªç‚¹/æ¢é’ˆï¼Œå†…æ ¸ç©ºé—´ç¨‹åºï¼ˆKSPï¼‰å°±ä¼šè¢«è§¦å‘å¹¶åœ¨å†…æ ¸å†…éƒ¨è¿è¡Œã€‚è¿™æ˜¯å®é™…çš„ eBPF é€»è¾‘å®ç°çš„åœ°æ–¹ã€‚

ç”±äºè¿™ä¸¤ä¸ªç¨‹åºæ— æ³•ç›´æ¥ç›¸äº’é€šä¿¡ï¼ˆæ ¹æ®è®¾è®¡ï¼‰ï¼Œå› æ­¤å®ƒä»¬éœ€è¦ä¸€ä¸ªç¼“å†²åŒºæ¥äº¤æ¢æ•°æ®ã€‚å¯¹äº eBPFï¼Œå®ƒæ˜¯é€šè¿‡ [ä¸åŒç±»å‹çš„ BPF æ˜ å°„](https://docs.kernel.org/bpf/maps.html) å®ç°çš„ã€‚



### æ„å»º

è®©æˆ‘ä»¬æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™å¤§çº¦éœ€è¦ 15 ç§’ï¼Œç„¶åä¼šç”Ÿæˆä¸€ä¸ªopensnoopå¯æ‰§è¡Œæ–‡ä»¶

```bash
make opensnoop
```



### è¿è¡Œ

è¦å®é™…è¿è¡Œå·²ç¼–è¯‘çš„ `opensnoop` äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéœ€è¦ `CAP_BPF` Linux åŠŸèƒ½ã€‚è¿™æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„é€»è¾‘ä½¿ç”¨ç‰¹æƒ BPF æ“ä½œï¼ˆä¾‹å¦‚ï¼Œå°† eBPF ä»£ç åŠ è½½åˆ°å†…æ ¸ä¸­ï¼‰ï¼ŒåŒæ—¶è®¸å¤š Linux å‘è¡Œç‰ˆä¸å…è®¸éç‰¹æƒ eBPFã€‚ `CAP_BPF` è‡ª Linux å†…æ ¸ 5.8 èµ·å¯ç”¨ï¼Œå…è®¸åŠ è½½æ‰€æœ‰ç±»å‹çš„ BPF ç¨‹åºã€åˆ›å»ºå¤§å¤šæ•°åœ°å›¾ç±»å‹ã€åŠ è½½ BTFã€è¿­ä»£ç¨‹åºå’Œåœ°å›¾ã€‚å¼•å…¥å®ƒæ˜¯ä¸ºäº†å°† BPF åŠŸèƒ½ä¸é‡è½½çš„ `CAP_SYS_ADMIN` åŠŸèƒ½åˆ†å¼€ã€‚

ç„¶è€Œï¼Œç”±äºåœ¨è¿™ä¸ªæ¼”ç¤ºç¯å¢ƒä¸­æˆ‘ä»¬æ— è®ºå¦‚ä½•éƒ½æ˜¯ä»¥ root èº«ä»½è¿è¡Œçš„ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯é—®é¢˜ã€‚è¿è¡Œ `opensnoop` ï¼š

```bash
./opensnoop
```



### ä½¿ç”¨ç¨‹åº

`opensnoop` ç°åœ¨å°†åœ¨æ¯æ¬¡æ‰“å¼€æ–‡ä»¶æ—¶æ˜¾ç¤ºè¾“å‡ºã€‚ä½†ç”±äºåƒæˆ‘ä»¬è¿™æ ·çš„å°å‹è™šæ‹Ÿæœºä¸­å‡ ä¹æ²¡æœ‰å‘ç”Ÿä»»ä½•äº‹æƒ…ï¼Œå› æ­¤æˆ‘ä»¬å°†ç”Ÿæˆä¸€äº›äº‹ä»¶ã€‚

é¡¶éƒ¨å·¦ä¾§ï¼Œåˆ‡æ¢åˆ°ç¬¬äºŒä¸ª>_2ï¸âƒ£Terminal 2é€‰é¡¹å¡ï¼Œæ‰§è¡Œï¼š

```bash
cat /etc/os-release

# è¾“å‡ºï¼š
PRETTY_NAME="Ubuntu 22.04.2 LTS"
NAME="Ubuntu"
VERSION_ID="22.04"
VERSION="22.04.2 LTS (Jammy Jellyfish)"
VERSION_CODENAME=jammy
ID=ubuntu
ID_LIKE=debian
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
UBUNTU_CODENAME=jammy
```

åˆ‡æ¢å›ç¬¬ä¸€ä¸ª>_1ï¸âƒ£Terminal 1é€‰é¡¹å¡ï¼ŒæŸ¥çœ‹è¾“å‡ºï¼šå·²ç»è®¿é—®äº†å¤šä¸ªæ–‡ä»¶ï¼Œç›´åˆ° `cat` æœ€ç»ˆè¾“å‡ºæ–‡ä»¶å†…å®¹ã€‚

```
PID    COMM              FD ERR PATH
2903   cat                3   0 /etc/ld.so.cache
2902   opensnoop         21   0 /etc/localtime
2903   cat                3   0 /lib/x86_64-linux-gnu/libc.so.6
2903   cat                3   0 /usr/lib/locale/locale-archive
2903   cat                3   0 /usr/share/locale/locale.alias
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_IDENTIFICATION
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_IDENTIFICATION
2903   cat                3   0 /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_MEASUREMENT
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_MEASUREMENT
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_TELEPHONE
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_TELEPHONE
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_ADDRESS
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_ADDRESS
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_NAME
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_NAME
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_PAPER
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_PAPER
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_MESSAGES
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_MESSAGES
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_MESSAGES/SYS_LC_MESSAGES
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_MONETARY
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_MONETARY
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_COLLATE
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_COLLATE
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_TIME
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_TIME
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_NUMERIC
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_NUMERIC
2903   cat               -1   2 /usr/lib/locale/C.UTF-8/LC_CTYPE
2903   cat                3   0 /usr/lib/locale/C.utf8/LC_CTYPE
2903   cat                3   0 /etc/os-release
2495   bash               3   0 /root/.bash_history
```

å¦‚æœæ‚¨ä¿æŒ `opensnoop` è¿è¡Œï¼Œæ‚¨æœ‰æ—¶å¯èƒ½ä¼šçœ‹åˆ°è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„å…¶ä»–è¿›ç¨‹ç”Ÿæˆçš„è¾“å‡ºï¼Œä¾‹å¦‚ `systemd` ã€‚

ç°åœ¨ï¼Œæ‚¨å¯ä»¥å•å‡»â€œæ£€æŸ¥â€æŒ‰é’®å¹¶è½¬åˆ°ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­è¿›è¡Œæ›´æ·±å…¥çš„ç ”ç©¶ã€‚

## æ£€æŸ¥BPFå¯¹è±¡æ–‡ä»¶

ç¬”è®°è€…ï¼šè¿™éƒ¨åˆ† readelf åº”è¯¥åœ¨æ±‡ç¼–åˆ†æé‡Œæ˜¯å¸¸è§„æ“ä½œäº†ï¼Œæˆ‘ä¸å¤ªç†Ÿæ‚‰ï¼Œå¦å¤–æ‰¾äº†äº›èµ„æ–™ï¼š

-   readelfæ˜¯ä¸€ä¸ªç”¨äºæŸ¥çœ‹äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“çš„ç¨‹åºã€‚
    å®ƒå¯ä»¥ç”¨æ¥ **æŸ¥çœ‹ ELF**ï¼ˆExecutable and Linking  Formatï¼‰æ–‡ä»¶çš„ä¿¡æ¯
-   ELFæ˜¯ä¸€ç§ç”¨äºUnixç±»æ“ä½œç³»ç»Ÿä¸­å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“çš„æ ‡å‡†æ–‡ä»¶æ ¼å¼ï¼Œå®ƒæ˜¯ä¸€ç§è‡ªæè¿°ã€å¯é‡å®šä½ã€å¯æ‰©å±•ã€å¯å‡çº§ã€è·¨å¹³å°çš„æ–‡ä»¶æ ¼å¼ã€‚
    å†…å®¹åŒ…å«äº†ï¼š
    -   æ–‡ä»¶å¤´ä¿¡æ¯
    -   ç¨‹åºæŒ‡ä»¤ã€æ•°æ®
    -   ç¨‹åºå¤´è¡¨
    -   èŠ‚å¤´è¡¨
    -   ç¬¦å·è¡¨
    -   åŠ¨æ€èŠ‚è¡¨
    -   é‡å®šå‘è¡¨
    -   â€¦â€¦ç­‰å„ç§è¯¦ç»†ä¿¡æ¯
-   .oæ–‡ä»¶æ˜¯ç›®æ ‡æ–‡ä»¶ï¼ŒåŒ…å«äº†ç¼–è¯‘å™¨ç¼–è¯‘æºä»£ç äº§ç”Ÿçš„æ±‡ç¼–ä»£ç å’Œç¬¦å·è¡¨ç­‰ä¿¡æ¯ï¼Œå®ƒé€šå¸¸æ˜¯è¢«ç¼–è¯‘å™¨è½¬æ¢æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–åº“æ–‡ä»¶çš„ä¸­é—´è¿‡ç¨‹ã€‚
    å› æ­¤ï¼Œ.oæ–‡ä»¶**å®é™…ä¸Šæ˜¯ä¸€ç§æœªå®Œæˆçš„ELFæ–‡ä»¶**ã€‚
    å®ƒåŒ…å«äº†ELFæ–‡ä»¶çš„éƒ¨åˆ†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤´ã€èŠ‚å¤´è¡¨ã€æ®µæ•°æ®ç­‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨readelfå‘½ä»¤æŸ¥çœ‹.oæ–‡ä»¶çš„åŸå› ã€‚é€šè¿‡æŸ¥çœ‹.oæ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¯ä»¥è·å¾—ç¼–è¯‘å™¨å°†æºä»£ç å’Œåº“æ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“çš„ä¸€äº›æç¤ºï¼Œæ¯”å¦‚ç¬¦å·è¡¨ã€é‡å®šä½ä¿¡æ¯ç­‰ï¼Œå¯¹äºç¨‹åºè°ƒè¯•å’Œåˆ†æéå¸¸æœ‰ç”¨ã€‚

### readelf

åœ¨å·¦ä¾§çš„ >_ 1ï¸âƒ£ ç»ˆç«¯ä¸­ï¼Œä½¿ç”¨ `readelf` æ£€æŸ¥æˆ‘ä»¬ä¹‹å‰ä½œä¸º `make` å‘½ä»¤çš„ä¸€éƒ¨åˆ†æ„å»ºçš„ BPF å¯¹è±¡æ–‡ä»¶ã€‚

```bash
readelf --section-details --headers .output/opensnoop.bpf.o

# è¾“å‡ºï¼š
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              REL (Relocatable file)
  Machine:                           Linux BPF
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          0 (bytes into file)
  Start of section headers:          11960 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           64 (bytes)
  Number of section headers:         20
  Section header string table index: 1

Section Headers:
  [Nr] Name
       Type              Address          Offset            Link
       Size              EntSize          Info              Align
       Flags
  [ 0] 
       NULL             0000000000000000  0000000000000000  0
       0000000000000000 0000000000000000  0                 0
       [0000000000000000]: 
  [ 1] .strtab
       STRTAB           0000000000000000  0000000000002c93  0
       0000000000000224 0000000000000000  0                 1
       [0000000000000000]: 
  [ 2] .text
       PROGBITS         0000000000000000  0000000000000040  0
       0000000000000000 0000000000000000  0                 4
       [0000000000000006]: ALLOC, EXEC
  [ 3] tracepoint/syscalls/sys_enter_open
       PROGBITS         0000000000000000  0000000000000040  0
       0000000000000170 0000000000000000  0                 8
       [0000000000000006]: ALLOC, EXEC
  [ 4] .reltracepoint/syscalls/sys_enter_open
       REL              0000000000000000  00000000000022d8  19
       0000000000000040 0000000000000010  3                 8
       [0000000000000040]: INFO LINK
  [ 5] tracepoint/syscalls/sys_enter_openat
       PROGBITS         0000000000000000  00000000000001b0  0
       0000000000000170 0000000000000000  0                 8
       [0000000000000006]: ALLOC, EXEC
  [ 6] .reltracepoint/syscalls/sys_enter_openat
       REL              0000000000000000  0000000000002318  19
       0000000000000040 0000000000000010  5                 8
       [0000000000000040]: INFO LINK
  [ 7] tracepoint/syscalls/sys_exit_open
       PROGBITS         0000000000000000  0000000000000320  0
       0000000000000330 0000000000000000  0                 8
       [0000000000000006]: ALLOC, EXEC
  [ 8] .reltracepoint/syscalls/sys_exit_open
       REL              0000000000000000  0000000000002358  19
       0000000000000040 0000000000000010  7                 8
       [0000000000000040]: INFO LINK
  [ 9] tracepoint/syscalls/sys_exit_openat
       PROGBITS         0000000000000000  0000000000000650  0
       0000000000000330 0000000000000000  0                 8
       [0000000000000006]: ALLOC, EXEC
  [10] .reltracepoint/syscalls/sys_exit_openat
       REL              0000000000000000  0000000000002398  19
       0000000000000040 0000000000000010  9                 8
       [0000000000000040]: INFO LINK
  [11] .rodata
       PROGBITS         0000000000000000  0000000000000980  0
       000000000000000d 0000000000000000  0                 4
       [0000000000000002]: ALLOC
  [12] .maps
       PROGBITS         0000000000000000  0000000000000990  0
       0000000000000038 0000000000000000  0                 8
       [0000000000000003]: WRITE, ALLOC
  [13] license
       PROGBITS         0000000000000000  00000000000009c8  0
       0000000000000004 0000000000000000  0                 1
       [0000000000000003]: WRITE, ALLOC
  [14] .BTF
       PROGBITS         0000000000000000  00000000000009cc  0
       0000000000000d8e 0000000000000000  0                 4
       [0000000000000000]: 
  [15] .rel.BTF
       REL              0000000000000000  00000000000023d8  19
       0000000000000070 0000000000000010  14                8
       [0000000000000040]: INFO LINK
  [16] .BTF.ext
       PROGBITS         0000000000000000  000000000000175c  0
       00000000000008ac 0000000000000000  0                 4
       [0000000000000000]: 
  [17] .rel.BTF.ext
       REL              0000000000000000  0000000000002448  19
       0000000000000840 0000000000000010  16                8
       [0000000000000040]: INFO LINK
  [18] .llvm_addrsig
       LOOS+0xfff4c03   0000000000000000  0000000000002c88  0
       000000000000000b 0000000000000000  0                 1
       [0000000080000000]: EXCLUDE
  [19] .symtab
       SYMTAB           0000000000000000  0000000000002008  1
       00000000000002d0 0000000000000018  19                8
       [0000000000000000]: 
```

### ELFæ ¼å¼

ç›®æ ‡æ–‡ä»¶ä¸º ELF æ ¼å¼ï¼ˆExecutable and Linkable Formatï¼Œå¯æ‰§è¡Œå’Œå¯é“¾æ¥æ ¼å¼ï¼‰ã€‚
å®ƒä»£è¡¨å¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡ä»£ç ã€å…±äº«åº“å’Œæ ¸å¿ƒè½¬å‚¨çš„é€šç”¨æ ‡å‡†æ–‡ä»¶æ ¼å¼ã€‚å®ƒä¹Ÿæ˜¯ x86 å¤„ç†å™¨ä¸ŠäºŒè¿›åˆ¶æ–‡ä»¶çš„æ ‡å‡†æ–‡ä»¶æ ¼å¼ã€‚

### å››ä¸ªå¯æ‰§è¡ŒèŠ‚

éœ€è¦è§‚å¯Ÿä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼š

-   æœºå™¨æ˜¯ `Linux BPF` ã€‚å› æ­¤ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥åœ¨ BPF å†…æ ¸è™šæ‹Ÿæœºå†…è¿è¡Œã€‚
-   è¯¥æ–‡ä»¶ä¸­åŒ…å« BTF ä¿¡æ¯ã€‚ BTF æ˜¯å…ƒæ•°æ®æ ¼å¼ï¼Œå¯¹ä¸ BPF ç¨‹åº/æ˜ å°„ç›¸å…³çš„è°ƒè¯•ä¿¡æ¯è¿›è¡Œç¼–ç ã€‚æ­¤è°ƒè¯•ä¿¡æ¯ç”¨äºåœ°å›¾æ¼‚äº®æ‰“å°ã€å‡½æ•°ç­¾åç­‰ã€‚
-   åœ¨è¡¨ä¸­åä¸º `.text` çš„èŠ‚å¤´ (å¯¹åº”[2]é‚£é‡Œ) ä¹‹åï¼Œæœ‰å››ä¸ªä»¥ `tracepoint` å¼€å¤´çš„å¯æ‰§è¡ŒèŠ‚ã€‚å®ƒä»¬å¯¹åº”äºå››ä¸ª BPF ç¨‹åº (å¯¹åº”[3~10, 8æ¡ï¼Œæ¯ä¸ªè¿½è¸ªç‚¹2æ¡])ã€‚

è®©æˆ‘ä»¬åœ¨ BPF æºä»£ç ä¸­æ‰¾åˆ°è¿™å››ä¸ªç¨‹åºã€‚åœ¨ç¬¬äºŒä¸ªé€‰é¡¹å¡  ç¼–è¾‘å™¨ä¸­ï¼Œæ‚¨å¯ä»¥æ‰“å¼€æ–‡ä»¶ `opensnoop.bpf.c` - æˆ‘ä»¬çš„å†…æ ¸ç©ºé—´ç¨‹åº (KSP)ã€‚
å‘ä¸‹æ»šåŠ¨æ‰¾åˆ°å››ä¸ªä¸åŒçš„å‡½æ•°ï¼Œ

```c
// å…¶åç§°ä»¥ `int tracepoint__syscalls...` å¼€å¤´ã€‚æ‚¨åº”è¯¥åœ¨ç¬¬ 50ã€68ã€125 å’Œ 131 è¡Œæ‰¾åˆ°å®ƒä»¬

/** ç¨‹åºè§£é‡Š
 * SEC()å®ï¼š
 *     å¯¹åº”äº `readelf` åˆ—å‡ºçš„å¯æ‰§è¡Œéƒ¨åˆ†ï¼Œå®šä¹‰äº†ä»£ç åº”é™„åŠ åˆ°çš„ eBPF [é’©å­](https://ebpf.io/what-is-ebpf/#hook-overview)
 *     å›ºå®šæ ¼å¼ï¼šSEC("tracepoint/<category>/<name>
 * è·Ÿè¸ªç‚¹ï¼š
 *     eBPF è·Ÿè¸ªç‚¹ è¿™é‡Œè®¾ç½®äº†4ä¸ª
 *     æ¯å½“å‘å‡º open()/enpenat() ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œç›¸åº”çš„eBPFä»£ç å‡½æ•°ã€‚
 *     è·Ÿè¸ªç‚¹æ˜¯å†…æ ¸ä»£ç ä¸­çš„é™æ€æ ‡è®°ï¼Œå¯ç”¨äºåœ¨æ­£åœ¨è¿è¡Œçš„å†…æ ¸ä¸­é™„åŠ  (eBPF) ä»£ç ã€‚è¿™äº›è·Ÿè¸ªç‚¹é€šå¸¸æ”¾ç½®åœ¨æœ‰è¶£çš„ä½ç½®æˆ–å¸¸è§çš„ä½ç½®æ¥æµ‹é‡æ€§èƒ½ã€‚
 * å››ä¸ªå¯æ‰§è¡Œç‚¹ï¼š
 *     æ¯å½“å‘å‡º open()/enpenat() ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œç›¸åº”çš„eBPFä»£ç å‡½æ•°ã€‚ç„¶åè§£æè°ƒç”¨çš„å‚æ•°ï¼ˆæ–‡ä»¶åç­‰ï¼‰å¹¶å°†æ­¤ä¿¡æ¯å†™å…¥ BPF æ˜ å°„ã€‚
 *     ä» BPFæ˜ å°„ é‚£é‡Œï¼Œæˆ‘ä»¬ç¼–è¯‘çš„ `opensnoop.c` äºŒè¿›åˆ¶éƒ¨åˆ† - æˆ‘ä»¬çš„ç”¨æˆ·ç©ºé—´ç¨‹åº (USP) - å¯ä»¥è¯»å–å®ƒå¹¶å°†å…¶æ‰“å°åˆ° STDOUT
 */

SEC("tracepoint/syscalls/sys_enter_open")
int tracepoint__syscalls__sys_enter_open(struct trace_event_raw_sys_enter* ctx) {...} // 50è¡Œ

SEC("tracepoint/syscalls/sys_enter_openat")
int tracepoint__syscalls__sys_enter_openat(struct trace_event_raw_sys_enter* ctx) {...} // 68è¡Œ
    
SEC("tracepoint/syscalls/sys_exit_open")
int tracepoint__syscalls__sys_exit_open(struct trace_event_raw_sys_exit* ctx) {...} // 125è¡Œ

SEC("tracepoint/syscalls/sys_exit_openat")
int tracepoint__syscalls__sys_exit_openat(struct trace_event_raw_sys_exit* ctx) {...} // 131è¡Œ
```

### å…¶ä»–

å¦‚æœæ‚¨æƒ³äº†è§£æœ‰å…³è¿™å››ä¸ª BPF ç¨‹åºæ­£åœ¨åšä»€ä¹ˆçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… Liz Rice æ‰€è‘—çš„ [ã€ŠWhat is eBPF ?ã€‹by Liz Rice](https://isovalent.com/ebpf/) ä¸€ä¹¦çš„ç¬¬ 3 ç« ã€‚

ä½†è¿™å¦‚ä½•ä¸ Linux å†…æ ¸ç»“åˆåœ¨ä¸€èµ·å‘¢ï¼Ÿå•å‡»â€œä¸‹ä¸€æ­¥â€ä»¥äº†è§£ä¸‹ä¸€éƒ¨åˆ†çš„å†…å®¹ã€‚

## ä½¿ç”¨ `bpftool` æŸ¥çœ‹åŠ è½½åˆ°å†…æ ¸ä¸­çš„BPFç¨‹åº

æŸ¥çœ‹å†…æ ¸ä¸­çš„ BPF ç¨‹åºï¼šç°åœ¨æˆ‘ä»¬çŸ¥é“ BPF ä»£ç æ­£åœ¨è¿è¡Œï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å†…æ ¸æ–¹é¢çš„äº‹æƒ…ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `bpftool` æ¥æŸ¥çœ‹æˆ‘ä»¬å·²åŠ è½½åˆ°å†…æ ¸ä¸­çš„å†…å®¹ã€‚



å½“å‰ `opensnoop` æœªè¿è¡Œã€‚è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æœºå™¨ä¸Šæ˜¯å¦æœ‰è¿è¡Œä»»ä½• eBPF ç¨‹åºã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ `bpftool` æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

bpftoolæ˜¯ä¸ eBPF ä¸€èµ·ä½¿ç”¨çš„ç‘å£«å†›åˆ€ã€‚å®ƒå¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°ï¼Œæˆ–è€…å¯¹äºæŸäº› Linux å‘è¡Œç‰ˆï¼ˆä¾‹å¦‚ Ubuntu å’Œ Fedoraï¼‰ï¼Œå¯ä»¥ç›´æ¥åœ¨ Linux å†…æ ¸å­˜å‚¨åº“ä¸­æ‰¾åˆ°ã€‚

### æŸ¥çœ‹è¿è¡Œçš„eBPFç¨‹åº `bpftool prog list`

```bash
bpftool prog list

# è¾“å‡º
65: cgroup_device  tag 28a890580b33b0dc  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 560B  jited 352B  memlock 4096B
        pids systemd(1)
66: cgroup_device  tag c8b47a902f1cc68b  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 464B  jited 289B  memlock 4096B
        pids systemd(1)
70: cgroup_device  tag e3dbd137be8d6168  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 504B  jited 310B  memlock 4096B
        pids systemd(1)
71: cgroup_device  tag 0ecd07b7b633809f  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 496B  jited 308B  memlock 4096B
        pids systemd(1)
72: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
73: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
74: cgroup_device  tag e3dbd137be8d6168  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 504B  jited 310B  memlock 4096B
        pids systemd(1)
75: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
76: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
80: cgroup_device  tag 8b9c33f36f812014  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 744B  jited 448B  memlock 4096B
        pids systemd(1)
81: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
82: cgroup_skb  tag 6deef7357e7b4530  gpl
        loaded_at 2023-07-19T05:34:43+0000  uid 0
        xlated 64B  jited 55B  memlock 4096B
        pids systemd(1)
```

ä¸€äº›è§£é‡Šï¼š

-   æ‚¨åº”è¯¥çœ‹åˆ°ä¸¤ç§æ¡ç›®ï¼š `cgroup_skb` å’Œ `cgroup_device` ã€‚ä¸¤è€…å‡ç”± Systemd ç»„ä»¶ systemd.resource-control ç®¡ç†ï¼Œå¹¶ç”¨äºç®¡ç† Systemd å•å…ƒå¯¹ç½‘ç»œè®¾å¤‡ï¼ˆè¯·å‚é˜…ç¤ºä¾‹ï¼‰å’Œæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ã€‚
-   ç›®å‰ä¸åº”æœ‰ä»»ä½• `tracepoint` ç±»å‹çš„æ¡ç›®

åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ï¼Œæˆ‘ä»¬è¿è¡Œ `opensnoop` ï¼š

```bash
./opensnoop
```

å½“å®ƒè¿è¡Œæ—¶ï¼Œåˆ‡æ¢å›ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œç„¶åé‡æ–°è¿è¡Œï¼š

```bash
bpftool prog list

# è¾“å‡ºï¼ˆç›¸è¾ƒäºç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œå¤šå‡ºæ¥äº†å››ä¸ªè¿½è¸ªç‚¹ï¼‰
98: tracepoint  name tracepoint__syscalls__sys_enter_open  tag 07014be5359438f8  gpl
        loaded_at 2023-07-19T05:54:41+0000  uid 0
        xlated 240B  jited 137B  memlock 4096B  map_ids 9,6
        btf_id 60
        pids opensnoop(2941)
100: tracepoint  name tracepoint__syscalls__sys_enter_openat  tag 8ee3432dcd98ffc3  gpl
        loaded_at 2023-07-19T05:54:41+0000  uid 0
        xlated 240B  jited 137B  memlock 4096B  map_ids 9,6
        btf_id 60
        pids opensnoop(2941)
101: tracepoint  name tracepoint__syscalls__sys_exit_open  tag 37f628f9e857b071  gpl
        loaded_at 2023-07-19T05:54:41+0000  uid 0
        xlated 792B  jited 546B  memlock 4096B  map_ids 6,9,7
        btf_id 60
        pids opensnoop(2941)
102: tracepoint  name tracepoint__syscalls__sys_exit_openat  tag 37f628f9e857b071  gpl
        loaded_at 2023-07-19T05:54:41+0000  uid 0
        xlated 792B  jited 546B  memlock 4096B  map_ids 6,9,7
        btf_id 60
        pids opensnoop(2941)
```

æ‚¨ä¼šçœ‹åˆ°å¦å¤–åŠ è½½äº†å››ä¸ª BPF ç¨‹åºï¼è¿™äº›å¯¹åº”äºå‰é¢æåˆ°çš„å››ä¸ª opensnoop BPF ç¨‹åºã€‚
è¯·æ³¨æ„ï¼Œåç§°è¢«æˆªæ–­ï¼Œå› æ­¤æ‚¨æ— æ³•çœŸæ­£çœ‹åˆ°å“ªä¸ªæ˜¯ç”¨äºè¿›å…¥æˆ–é€€å‡ºçš„ã€‚
ä½†æ˜¯ï¼Œå®ƒä»¬æ¯ä¸ªéƒ½å¼•ç”¨ä¸¤ä¸ªæˆ–ä¸‰ä¸ªåœ°å›¾ IDï¼Œä¾‹å¦‚ `map_ids 11,8` ï¼ˆæ•°å­—å¯èƒ½ä¸åŒï¼‰ã€‚è®©æˆ‘ä»¬åˆ©ç”¨è¿™äº›ä¿¡æ¯å§ï¼

### åŠ è½½åˆ°å†…æ ¸ä¸­çš„æ˜ å°„ `bpftool map list`

å½“ opensnoop ä»åœ¨ç¬¬äºŒä¸ª >\_2ï¸âƒ£ ç»ˆç«¯ 2 ä¸­è¿è¡Œæ—¶ï¼Œç•™åœ¨ç¬¬ä¸€ä¸ª >\_1ï¸âƒ£ ç»ˆç«¯ 1 ä¸­å¹¶è§‚å¯ŸåŠ è½½åˆ°å†…æ ¸ä¸­çš„æ˜ å°„

```bash
bpftool map list

# è¾“å‡ºï¼Œè¾“å‡ºæ˜¾ç¤ºäº†ä¸€äº›ç°æœ‰çš„ BPF æ˜ å°„
6: hash  name start  flags 0x0
        key 4B  value 16B  max_entries 10240  memlock 245760B
        btf_id 60
        pids opensnoop(2941)
7: perf_event_array  name events  flags 0x0
        key 4B  value 4B  max_entries 1  memlock 4096B
        pids opensnoop(2941)
9: array  name opensnoo.rodata  flags 0x480
        key 4B  value 13B  max_entries 1  memlock 4096B
        btf_id 60  frozen
        pids opensnoop(2941)
17: array  name pid_iter.rodata  flags 0x480
        key 4B  value 4B  max_entries 1  memlock 4096B
        btf_id 76  frozen
        pids bpftool(2951)
18: array  name libbpf_det_bind  flags 0x0
        key 4B  value 32B  max_entries 1  memlock 4096B
```

ä¸€äº›è§£é‡Šï¼š

-   è§‚å¯Ÿåˆ°æœ‰ä¸€ä¸ªåä¸º `start` çš„å“ˆå¸Œè¡¨å’Œä¸€ä¸ªåä¸º `events` çš„æ€§èƒ½äº‹ä»¶æ•°ç»„ã€‚è¿™äº›åœ¨æºä»£ç ä¸­çš„ `~/bcc/libbpf-tools/opensnoop.bpf.c` ç¬¬ 13-24 è¡Œä¸­å®šä¹‰ã€‚åœ¨  ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹ä¸€ä¸‹ã€‚
-   è¿˜æœ‰ä¸€ä¸ªç”¨äº opensnoop åªè¯»æ•°æ®çš„æ•°ç»„ ( `array  name opensnoo.rodata` )ã€‚
-   å¦è¯·æ³¨æ„ï¼Œæ¯è¡Œå¼€å¤´çš„åœ°å›¾ ID ä¸ä¹‹å‰ `bpftool prog list` å¼•ç”¨çš„ ID ç›¸å¯¹åº”ã€‚

### è§‚å¯Ÿç¨‹åºå­—èŠ‚ç  `bpftool prog dump xlated id 98 linum`

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªç¨‹åºçš„å­—èŠ‚ç ã€‚ä¸ºæ­¤ï¼Œè®©æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ä¸€ä¸‹ prog åˆ—è¡¨ã€‚åœ¨ >_ 1ï¸âƒ£ ç»ˆç«¯ 1 ä¸­æ‰§è¡Œï¼š

```bash
bpftool prog list
```

åœ¨æ¯è¡Œçš„å¼€å¤´ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ç›¸åº” BPF ç¨‹åºçš„ IDã€‚è·å– `tracepoint` ç¨‹åºçš„ IDï¼Œå¹¶è½¬å‚¨å­—èŠ‚ç ï¼ˆåœ¨æˆ‘ä»¬çš„è¿è¡Œä¸­ï¼Œç¼–å·ä¸º `46` ï¼Œæ‚¨çš„ç¼–å·å¯èƒ½ä¸åŒï¼‰ï¼š

```bash
bpftool prog dump xlated id 98 linum

# è¾“å‡º
int tracepoint__syscalls__sys_enter_open(struct trace_event_raw_sys_enter * ctx):
; int tracepoint__syscalls__sys_enter_open(struct trace_event_raw_sys_enter* ctx) [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:50 line_col:0]
   0: (bf) r6 = r1
; u64 id = bpf_get_current_pid_tgid(); [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:52 line_col:11]
   1: (85) call bpf_get_current_pid_tgid#186208
; u32 pid = id; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:55 line_col:6]
   2: (63) *(u32 *)(r10 -4) = r0
; if (targ_tgid && targ_tgid != tgid) [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:36 line_col:6]
   3: (18) r1 = map[id:9][0]+4
   5: (61) r2 = *(u32 *)(r1 +0)
; if (targ_pid && targ_pid != pid) [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:38 line_col:6]
   6: (18) r1 = map[id:9][0]+0
   8: (61) r2 = *(u32 *)(r1 +0)
; if (valid_uid(targ_uid)) { [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:40 line_col:16]
   9: (18) r7 = map[id:9][0]+8
  11: (61) r1 = *(u32 *)(r7 +0)
  12: (18) r2 = 0xffffffff
; if (targ_uid != uid) { [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:42 line_col:7]
  14: (b7) r1 = 0
; struct args_t args = {}; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:59 line_col:17]
  15: (7b) *(u64 *)(r10 -16) = r1
; args.fname = (const char *)ctx->args[0]; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:60 line_col:30]
  16: (79) r1 = *(u64 *)(r6 +16)
; args.fname = (const char *)ctx->args[0]; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:60 line_col:14]
  17: (7b) *(u64 *)(r10 -24) = r1
; args.flags = (int)ctx->args[1]; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:61 line_col:21]
  18: (79) r1 = *(u64 *)(r6 +24)
; args.flags = (int)ctx->args[1]; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:61 line_col:14]
  19: (63) *(u32 *)(r10 -16) = r1
  20: (bf) r2 = r10
; struct args_t args = {}; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:59 line_col:17]
  21: (07) r2 += -4
  22: (bf) r3 = r10
  23: (07) r3 += -24
; bpf_map_update_elem(&start, &pid, &args, 0); [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:62 line_col:3]
  24: (18) r1 = map[id:6]
  26: (b7) r4 = 0
  27: (85) call htab_map_update_elem#220464
; return 0; [file:/opt/ebpf/bcc/libbpf-tools/opensnoop.bpf.c line_num:64 line_col:2]
  28: (b7) r0 = 0
  29: (95) exit
```

å¦‚æ‚¨æ‰€è§ï¼Œè¿™æ˜¾ç¤ºäº†æœ‰å…³æºä»£ç çš„ä¿¡æ¯ã€‚åˆ‡æ¢åˆ°  ç¼–è¾‘å™¨é€‰é¡¹å¡å¹¶æ‰“å¼€æ–‡ä»¶ `opensnoop.bpf.c` ã€‚å°† >_1ï¸âƒ£ ç»ˆç«¯ 1 ä¸­è¾“å‡ºçš„è¡Œå·ä¸æºä»£ç æ–‡ä»¶ä¸­çš„è¡Œå·è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦åŒ¹é…ã€‚è¿™ä½¿å¾—æ¯”è¾ƒ BPF ç¼–è¯‘å¯¹è±¡å’Œå®ƒèƒŒåçš„æºä»£ç å˜å¾—ç›¸å½“å®¹æ˜“ï¼

ï¼ˆä¸åŸä»£ç ç›¸æ¯”ï¼Œè¿™é‡Œæœ‰ä¸€äº›åŒºåˆ«ï¼‰

èƒ½å¤Ÿç¼–å†™è‡ªå·±çš„ BPF ä»£ç ä¸æ˜¯å¾ˆæ£’å—ï¼Ÿå•å‡»ä¸‹ä¸€æ­¥å¹¶æ‰§è¡Œæ­¤æ“ä½œï¼

## æ·»åŠ æ‚¨è‡ªå·±çš„è·Ÿè¸ªæ¶ˆæ¯

ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼šç°åœ¨æˆ‘ä»¬çŸ¥é“å¦‚ä½•è¿è¡Œ eBPF å·¥å…·ï¼Œå¦‚ä½•è§‚å¯Ÿå®ƒä»¬çš„è¡Œä¸ºï¼Œæ£€æŸ¥å†…æ ¸ä¸­åŠ è½½çš„å†…å®¹ï¼Œç”šè‡³è·å–ä¸å®é™…æºä»£ç ç›¸æ¯”å®é™…å‘ç”Ÿçš„æƒ…å†µçš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦ç¼–å†™å®é™…çš„ä»£ç ï¼ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬è‡ªå·±çš„è·Ÿè¸ªæ¶ˆæ¯æ·»åŠ åˆ°ä»£ç ä¸­ï¼

### ä¸¤ç§è°ƒè¯•æ‰“å°æ–¹æ³•

eBPF ç¨‹åºå¯ä»¥å‡ºäºè°ƒè¯•ç›®çš„ç¼–å†™è·Ÿè¸ªæ¶ˆæ¯ã€‚å¯¹äºé€šå¸¸é€šè¿‡ `trace_pipe` å®Œæˆçš„å¿«é€Ÿç¤ºä¾‹ï¼Œå¯ä»¥ä» `/sys/kernel/debug/tracing/trace_pipe` è¯»å–ã€‚
ä½†æ˜¯ï¼Œå®ƒæœ‰ä¸€äº›é™åˆ¶ï¼šæœ€å¤§ 3 ä¸ªå‚æ•°ï¼Œtrace_pipe æ˜¯å…¨å±€å…±äº«çš„ï¼ˆå› æ­¤å¹¶å‘ç¨‹åºå°†äº§ç”Ÿå†²çªçš„è¾“å‡ºï¼‰ï¼Œç­‰ç­‰ã€‚
å› æ­¤ï¼Œæ‚¨ä¸åº”è¯¥å°†å…¶ç”¨äºé«˜æ•ˆçš„ eBPF ä»£ç ã€‚æ‚¨åº”è¯¥é€šè¿‡ `BPF_PERF_OUTPUT()` ç•Œé¢æ¥å®Œæˆæ­¤æ“ä½œã€‚
å°½ç®¡å¦‚æ­¤ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨æœ¬å®éªŒä¸­é€šè¿‡ `trace_pipe` è¿›è¡Œæ“ä½œï¼Œå¹¶å°†æˆ‘ä»¬è‡ªå·±çš„æ¶ˆæ¯æ·»åŠ åˆ° `opensnoop` ä¸­ã€‚

### ä¿®æ”¹ç¨‹åºå¹¶é‡æ–°è¿è¡Œ

åœ¨  ç¼–è¾‘å™¨é€‰é¡¹å¡çš„æ–‡ä»¶åˆ—è¡¨å·¦ä¾§ï¼Œå‘ä¸‹æ»šåŠ¨å¹¶é€‰æ‹©æ–‡ä»¶ `opensnoop.bpf.c` ã€‚æ‰¾åˆ° `cleanup:` æ ‡ç­¾ï¼Œå®ƒåº”è¯¥ä½äºç¬¬ 119 è¡Œå·¦å³ã€‚åœ¨å…¶ä¸­ï¼Œåœ¨å…¶ä¸Šæ–¹æ·»åŠ ä»¥ä¸‹è¡Œ `bpf_printk("Hello world");`ï¼Œä¿®æ”¹åæ–‡ä»¶åº”å¦‚ä¸‹æ‰€ç¤ºï¼š

```c
   /* emit event */
   bpf_perf_event_output(ctx, &events, BPF_F_CURRENT_CPU,
                 &event, sizeof(event));
   bpf_printk("Hello world"); // æ·»åŠ è¿™ä¸€è¡Œï¼Œå…¶ä»–ä¸åŠ¨
cleanup: // åŸæ¥å¤„äºç¬¬119è¡Œ
   bpf_map_delete_elem(&start, &pid);
   return 0;
}
```

å•å‡»  ç¼–è¾‘å™¨çª—å£é¡¶éƒ¨é€‰é¡¹å¡ä¸­çš„ ğŸ’¾ ä¿å­˜æ–‡ä»¶ã€‚

åœ¨ >_ 1ï¸âƒ£ Terminal 1 é€‰é¡¹å¡ä¸­ï¼Œé‡å»ºç°åœ¨æ›´æ”¹çš„ `opensnoop` ï¼š

```bash
make opensnoop
```

æ¥ä¸‹æ¥ï¼Œåœ¨æ‰§è¡Œæ–°æ„å»ºä¹‹å‰ï¼Œå¼€å§‹è¯»å–ç¬¬äºŒä¸ª>_2ï¸âƒ£ç»ˆç«¯ 2 ä¸­çš„å†…æ ¸è·Ÿè¸ªè¾“å‡ºæ–‡ä»¶ï¼š

```bash
cat /sys/kernel/debug/tracing/trace_pipe
```

å¼€å§‹æ—¶ä¸ä¼šæ˜¾ç¤ºä»»ä½•è¾“å‡º - å®ƒæ­£åœ¨ç­‰å¾…æ•°æ®

ç°åœ¨ï¼Œåœ¨ç¬¬ä¸€ä¸ª>_1ï¸âƒ£ç»ˆç«¯1ä¸­ï¼Œè¿è¡Œ `opensnoop` ï¼š

```bash
./opensnoop
```

ç°åœ¨æˆ‘ä»¬åªéœ€è¦ç”Ÿæˆæ–‡ä»¶è®¿é—®æƒé™ã€‚åœ¨  ç¼–è¾‘å™¨ä¸­ï¼Œå•å‡»ä»»æ„æ–‡ä»¶ã€‚åœ¨ç¼–è¾‘å™¨ä¸­åŠ è½½æ–‡ä»¶ä¼šç”Ÿæˆå¾ˆå¤šäº‹ä»¶ã€‚
åˆ‡æ¢åˆ° >_ 1ï¸âƒ£ è¿è¡Œ `opensnoop` çš„ç»ˆç«¯ 1ï¼Œè§‚å¯Ÿæœ‰å¤§é‡æ–‡ä»¶è®¿é—®ã€‚
è½¬åˆ°ç¬¬äºŒä¸ª >_ 2ï¸âƒ£ ç»ˆç«¯ 2ï¼Œæˆ‘ä»¬çš„ `cat` è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå¹¶è§‚å¯Ÿåˆ°æ‰“å°äº†å¾ˆå¤šè·Ÿè¸ªæ¶ˆæ¯ï¼

```bash
   sandbox-agent-1778    [000] d...1  2066.381919: bpf_trace_printk: Hello world
   sandbox-agent-1778    [000] d...1  2066.381932: bpf_trace_printk: Hello world
   sandbox-agent-1778    [000] d...1  2066.381951: bpf_trace_printk: Hello world
   sandbox-agent-1778    [000] d...1  2066.381970: bpf_trace_printk: Hello world
   sandbox-agent-1778    [000] d...1  2066.381989: bpf_trace_printk: Hello world
```

### è¡¥å……

æ­å–œï¼Œæ‚¨å·²ç»ç¼–å†™äº†ä¸€äº› eBPF ä»£ç å¹¶åœ¨å†…æ ¸ä¸­è¿è¡Œå®ƒï¼

è¯·æ³¨æ„ï¼Œé™¤äº†æ˜¾ç¤ºæ‚¨å®šä¹‰çš„å­—ç¬¦ä¸²å¤–ï¼Œè·Ÿè¸ªè¡Œè¿˜åŒ…æ‹¬å…¶ä»–æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ - ä¾‹å¦‚ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„åç§°å’Œè§¦å‘è¿è¡Œç¨‹åºçš„äº‹ä»¶çš„è¿›ç¨‹ ID - åœ¨æœ¬ä¾‹ä¸­ä¸º `sandbox-agent` è¿è¡Œã€‚

è¿™è¯´æ˜äº† eBPF ç¨‹åºå¦‚ä½•æ”¶é›†æœ‰å…³è§¦å‘å®ƒçš„äº‹ä»¶çš„æœ‰ç”¨ä¿¡æ¯ - ä¾‹å¦‚ï¼Œå¯ä»¥å‡ºäºå¯è§‚å¯Ÿæ€§ç›®çš„å°†å…¶æŠ¥å‘Šç»™ç”¨æˆ·ç©ºé—´ã€‚

## eBPFå…¥é—¨æµ‹éªŒ

ï¼ˆè’™äº†å‡ æ¬¡æ‰è’™å¯¹äº†ï¼‰

-   âŒ eBPF ç¨‹åºå§‹ç»ˆéœ€è¦ Linux åŠŸèƒ½â€œCAP_BPFâ€ å’Œ â€œCAP_SYS_ADMINâ€
-   âœ… ELF ä»£è¡¨ x86 æ¶æ„ä¸Šå¯æ‰§è¡Œæ–‡ä»¶çš„é€šç”¨æ ‡å‡†æ–‡ä»¶æ ¼å¼
-   âœ… eBPF ç¨‹åºä½¿ç”¨ BPF æ˜ å°„ä¸ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºäº¤æ¢æ•°æ®
-   âŒ â€œBPF_PERF_OUTPUT()â€ æ¥å£å¯ç”¨äºé€šè¿‡å‘ç”¨æˆ·ç©ºé—´æä¾›æ¶ˆæ¯æ¥å¯¹å†…æ ¸ç©ºé—´ç¨‹åºè¿›è¡Œæ•…éšœæ’é™¤ã€‚
-   âœ… æ¯å½“ç”¨æˆ·ç©ºé—´ç¨‹åºå°è¯•ä¸å†…æ ¸ç©ºé—´ç¨‹åºäº¤æ¢æ•°æ®æ—¶ï¼Œå®ƒä»¬éƒ½éœ€è¦ä½¿ç”¨ eBPF æ˜ å°„











